name: OpenWrt Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: main-repo  # 明确指定检出路径

    - name: Fix permissions
      run: |
        chmod +x main-repo/scripts/*.sh
        ls -al main-repo/scripts  # 验证权限

    - name: Setup coreutils
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential coreutils

    - name: Clone OpenWrt
      run: |
        git clone --depth=1 --branch=openwrt-24.10 https://github.com/openwrt/openwrt.git
        chmod +x openwrt/scripts/*.sh  # 确保官方脚本可执行

    - name: Apply config
      working-directory: openwrt  # 明确工作目录
      run: |
        ../main-repo/scripts/apply_custom.sh

    - name: Build system
      working-directory: openwrt
      run: |
        make -j2 V=s 2>&1 | tee build.log
