name: OpenWrt Build Fixed

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-24.10
  BUILD_DIR: ${{ github.workspace }}/output
  KERNEL_TARGET: 6.1  # 根据实际可用内核调整

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check kernel compatibility
      run: |
        docker run --rm ${{ env.DOCKER_IMAGE }} \
          ls target/linux/x86/config-* > kernels.txt
        if ! grep -q "${{ env.KERNEL_TARGET }}" kernels.txt; then
          echo "::error::Kernel ${{ env.KERNEL_TARGET }} not available!"
          exit 1
        fi

    - name: Build with verified kernel
      run: |
        docker run --rm \
          -v ${{ env.BUILD_DIR }}:/imagebuilder/bin \
          ${{ env.DOCKER_IMAGE }} \
          make image \
          PROFILE="generic" \
          KERNEL_PATCHVER="${{ env.KERNEL_TARGET }}" \
          PACKAGES="base-files luci" \
          BIN_DIR="/imagebuilder/bin"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        path: ${{ env.BUILD_DIR }}/targets/x86/64/*.img.gz
