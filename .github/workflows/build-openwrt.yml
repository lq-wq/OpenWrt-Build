name: Build OpenWrt with Debug

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-24.10
  ADMIN_IP: 192.168.6.1
  KERNEL_VERSION: 6.6

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System cleanup
      run: |
        sudo rm -f /var/lib/dpkg/lock*
        sudo dpkg --configure -a
        docker system prune -f

    - name: Prepare workspace
      run: |
        mkdir -p files/etc/config artifacts
        # 生成最小化网络配置
        cat > files/etc/config/network <<EOF
        config interface 'loopback'
            option ifname 'lo'
            option proto 'static'
            option ipaddr '127.0.0.1'
            option netmask '255.0.0.0'

        config interface 'lan'
            option ifname 'eth0'
            option proto 'static'
            option ipaddr '${{ env.ADMIN_IP }}'
            option netmask '255.255.255.0'
        EOF

    - name: Build image (debug)
      run: |
        docker run --rm \
          -e FORCE_UNSAFE_CONFIGURE=1 \
          -v $PWD/artifacts:/home/builder/imagebuilder/bin \
          -v $PWD/files:/home/builder/custom_files \
          ${{ env.DOCKER_IMAGE }} \
          bash -c "make image V=s \
            PROFILE='generic' \
            KERNEL_PATCHVER='${{ env.KERNEL_VERSION }}' \
            PACKAGES='luci luci-ssl-openssl luci-compat' \
            FILES='/home/builder/custom_files' || { cat build.log; exit 1; }"

    - name: Upload logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          artifacts/build.log
          artifacts/feeds.log
