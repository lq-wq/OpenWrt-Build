name: OpenWrt Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    env:
      OPENWRT_DIR: ${{ github.workspace }}/openwrt

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: src

    - name: Fix file permissions
      run: |
        find src/scripts -type f -name "*.sh" -exec chmod +x {} \;
        ls -l src/scripts/*.sh

    - name: Prepare environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev \
        zlib1g-dev gawk git gettext python3 python3-pip rsync

    - name: Clone OpenWrt
      run: |
        git clone --depth=1 --branch=openwrt-24.10 https://github.com/openwrt/openwrt.git ${{ env.OPENWRT_DIR }}
        cd ${{ env.OPENWRT_DIR }}
        chmod +x scripts/feeds scripts/env scripts/*.pl

    - name: Apply custom configuration
      working-directory: ${{ env.OPENWRT_DIR }}
      run: |
        ../../src/scripts/apply_custom.sh
        make defconfig

    - name: Build system
      working-directory: ${{ env.OPENWRT_DIR }}
      run: |
        make -j2 V=s 2>&1 | tee build.log
