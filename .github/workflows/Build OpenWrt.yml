name: OpenWrt Build

on: [push]

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TARGET: x86/64   # 根据需求修改
  PROFILE: generic

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Env
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
        libssl-dev python3 python3-distutils python3-setuptools python3-venv rsync \
        unzip wget python3-pip zlib1g-dev
        
    - name: Clone OpenWrt
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        
    - name: Apply Custom Config
      run: |
        # 应用你的自定义配置
        cp ../config/$TARGET.config .config
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Build
      env:
        CCACHE_DIR: ${{ github.workspace }}/ccache
        CCACHE_MAXSIZE: 4G
      run: |
        cd openwrt
        make -j$(nproc) download
        make -j$(nproc) V=s CCACHE=1
