name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TARGET: x86/64   # 根据需求修改
  PROFILE: generic
  CONFIG_PATH: ${{ github.workspace }}/config/x86_64.config  # 新增配置文件路径

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Env
      run: |
        sudo apt-get update
        sudo add-apt-repository universe  # 添加 universe 仓库
        sudo apt-get update  # 更新包列表
        echo "deb http://downloads.openwrt.org/releases/24.10/targets/x86/64/packages/ /" | sudo tee /etc/apt/sources.list.d/openwrt.list  # 修改为正确的 openwrt 包仓库路径
        sudo apt-get update  # 更新包列表
        sudo apt-get -y install build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
        libssl-dev python3 python3-distutils python3-setuptools python3-venv rsync \
        unzip wget python3-pip zlib1g-dev libuci-dev uci-core  # 添加 libuci-dev 和 uci-core
        
    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: ${{ github.workspace }}/ccache
        key: ${{ runner.os }}-ccache-${{ env.TARGET }}
        restore-keys: |
          ${{ runner.os }}-ccache-
        
    - name: Clone OpenWrt
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        
    - name: Apply Custom Config
      run: |
        cd openwrt
        cp ${{ env.CONFIG_PATH }} .config
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig  # 同步配置文件

    - name: Run diy-part1.sh
      run: |
        cd openwrt
        if [ -f ../diy-part1.sh ]; then
          bash ../diy-part1.sh
        else
          echo "diy-part1.sh not found!"
        fi

    - name: Run diy-part2.sh
      run: |
        cd openwrt
        if [ -f ../diy-part2.sh ]; then
          bash ../diy-part2.sh
        else
          echo "diy-part2.sh not found!"
        fi

    - name: Set Custom Management IP, Username, and Password
      run: |
        cd openwrt
        # 设置后台管理IP
        sed -i 's/^#*\(option ipaddr \).*/\1192.168.1.1/' package/base-files/files/bin/config_generate
        # 设置用户名
        sed -i 's/^#*\(option username \).*/\1admin/' package/base-files/files/etc/config/user
        # 设置密码
        echo "root:your_password" | chpasswd -c SHA512 /dev/stdin > package/base-files/files/etc/shadow
        
    - name: Build
      env:
        CCACHE_DIR: ${{ github.workspace }}/ccache
        CCACHE_MAXSIZE: 4G
      run: |
        cd openwrt
        make -j$(nproc) download
        make -j$(nproc) V=s CCACHE=1
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        
    - name: Upload Firmware
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./openwrt/bin/targets/x86/64/openwrt-x86-64-generic-squashfs-combined.img.gz
        asset_name: openwrt-x86-64-generic-squashfs-combined.img.gz
        asset_content_type: application/octet-stream
